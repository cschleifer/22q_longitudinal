---
title: "22q_longitudinal_gamm"
author: "charlie schleifer"
date: "5/10/2022"
output: html_document
---
## Overview
This script uses Generalized Additive Mixed Models (GAMMs) to model non-parametric age trajectories for thalamocortical functional network connectivity in 22qDel patiens and typical controls. A random effects implementation of the ComBat algorithm (longCombat) is used to harmonize data from multiple sites.  

## Set up workspace
ciftiTools is an R package for analysis and plotting of CIFTI dscalar, dlabel, and dtseries files:
https://htmlpreview.github.io/?https://github.com/mandymejia/ciftiTools/blob/master/vignettes/ciftiTools_vignette.html
many ciftiTools functions require connectome workbench to be downloaded and installed locally:
https://www.humanconnectome.org/software/get-connectome-workbench
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# clear workspace
rm(list = ls(all.names = TRUE))

# use SSHFS to mount hoffman2 server (download SSHFS for mac: https://osxfuse.github.io/)
# TODO: set hoffman2 username
uname <- "schleife"
# set local path to mount server
hoffman <- "~/Desktop/hoffman_mount"
# create directory if needed 
if(!file.exists(hoffman)){dir.create(hoffman)}
# make string to run as system command
mntcommand <- paste0("umount -f ", hoffman,"; sshfs ",uname,"@hoffman2.idre.ucla.edu:/u/project/cbearden/data ",hoffman)
# if hoffman directory is empty, use system command and sshfs to mount server, if not empty assume already mounted and skip
if(length(list.files(hoffman)) == 0){system(mntcommand)}else{print(paste(hoffman,"is not empty...skipping SSHFS step"))}

# list packages to load
packages <- c("conflicted", "here", "magrittr", "mgcv", "gratia", "lme4", "lmerTest", "invgamma", "longCombat", "ciftiTools", "readxl", "dplyr", "data.table", "DescTools","tableone", "tibble", "reshape2", "viridis", "scico", "ggplot2", "gridExtra", "ggpubr")

# install packages if not yet installed
all_packages <- rownames(installed.packages())
installed_packages <- packages %in% all_packages
if (any(installed_packages == FALSE)){install.packages(packages[!installed_packages])}

# load packages
invisible(lapply(packages, library, character.only = TRUE))

# use the filter function from dplyr, not stats
conflict_prefer("filter", "dplyr")

# get path to project repo directory
project <- here()
print(paste("Project directory:", project))

# set up connectome workbench path for ciftiTools
# https://www.humanconnectome.org/software/get-connectome-workbench
# local wbpath (edit this path if workbench is installed in another location, e.g. on hoffman: /u/project/CCN/apps/hcp/current/workbench/bin_rh_linux64/)
# TODO: edit if necessary
wbpath <- "/Applications/workbench/bin_macosx64/"
ciftiTools.setOption("wb_path", wbpath)

# load rgl for ciftiTools visualization
# may require XQartz v2.8.1 to be installed locally
if(!require('rgl', quietly=TRUE)){install.packages('rgl')}
rgl::setupKnitr()
rgl::rgl.open(); rgl::rgl.close()
```

## load CAB-NP atlas
RSN atlas of whole cortex and subcortex to use for thalamus striatum connectivity analysis. Atlas can be downloaded here: https://github.com/ColeLab/ColeAnticevicNetPartition
load key for Ji parcels/networks
```{r message=FALSE,include=FALSE,warning=FALSE}
ji_key <- read.table(file.path(project,"CAB-NP/CortexSubcortex_ColeAnticevic_NetPartition_wSubcorGSR_parcels_LR_LabelKey.txt"),header=T)
ji_net_keys <- ji_key[,c("NETWORKKEY","NETWORK")] %>% distinct %>% arrange(NETWORKKEY)
print(ji_net_keys)

# read cifti with subcortical structures labeled 
xii_Ji_parcel <- read_cifti(file.path(project,"CAB-NP/CortexSubcortex_ColeAnticevic_NetPartition_wSubcorGSR_parcels_LR.dscalar.nii"), brainstructures = "all")
xii_Ji_network <- read_cifti(file.path(project,"CAB-NP/CortexSubcortex_ColeAnticevic_NetPartition_wSubcorGSR_netassignments_LR.dscalar.nii"), brainstructures = "all")

#view_xifti_volume(xii_Ji_parcel,colors="viridis",title="parcels",cex.title=1.3)
#view_xifti_volume(xii_Ji_network,colors="Paired",title="networks",cex.title=1.3)
```

## Load individual TC connectivity CSVs
computed by 22q_multisite_networkTC_save_individual.R and saved as a CSV with one value per network representing the z-transformed pearson correlation between signals in the thalamic and cortical subsets of that network
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# paths to sessions directories
trio_dir <- file.path(hoffman,"22q/qunex_studyfolder/sessions")
prisma_dir <- file.path(hoffman,"22qPrisma/qunex_studyfolder/sessions")

# get list of sessions
trio_sessions <- list.files(trio_dir,pattern="Q_[0-9]")
prisma_sessions <- list.files(prisma_dir,pattern="Q_[0-9]")
all_sessions <- c(trio_sessions,prisma_sessions)

# function to read thalamocortical results and add columns for roi pair name, site, and ID 
read_tc_results <- function(sdir, fname, sesh, site){
  input <- read.csv(file.path(sdir,sesh,"images/functional",fname))
  session <- rep(sesh, times=nrow(input)) %>% as.data.frame
  site <- rep(site, times=nrow(input)) %>% as.data.frame
  new_cols <- cbind(session,site)
  colnames(new_cols) <- c("MRI_S_ID","site")
  output <- cbind(input,new_cols)
  return(output)
}

# file name to look for
tc_name <- "resting_fc_network_Thal_Cortex_Atlas_s_hpss_res-mVWMWB1d_lpss_CABNP.csv"

# read for trio and prisma then combine
trio_tc <- lapply(trio_sessions, function(s) read_tc_results(sesh=s,site="trio",sdir=trio_dir,fname=tc_name)) %>% do.call(rbind,.) %>% as.data.frame
prisma_tc <- lapply(prisma_sessions, function(s) read_tc_results(sesh=s,site="prisma",sdir=prisma_dir,fname=tc_name)) %>% do.call(rbind,.) %>% as.data.frame
all_tc <- rbind(trio_tc,prisma_tc) %>% filter(!is.na(TC_Fz))

# replaces dashes with underscores for network names
all_tc$NETWORK <- all_tc$NETWORK %>% gsub("-","_",.)

# cast to wide for combat
setDT(all_tc)
all_tc_wide <- reshape2::dcast(all_tc, MRI_S_ID + site ~ NETWORK, value.var="TC_Fz") 
```

## load sistat data and get lists of scans to use
all sistat tables should be exported as CSVs into a single directory
the next several chunks deal with reading, cleaning and annotating the data exported from sistat, and then age matching
the hcs sample is younger than del due to a large amount of very young hcs subjects. plan is to match samples by using followup timepoints rather than baseline for some younger participants, and dropping several older del subjects, and younger hcs subjects (prioritizing dropping subjects with worse motion stats when possible)
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# set location of directory with ucla sistat CSVs
csvdir_ucla <- file.path(project,"demographics/ucla_sistat")

# get list of files_ucla in directory
files_ucla <- list.files(csvdir_ucla)
fpaths <- lapply(files_ucla, function(file) paste(csvdir_ucla,file,sep="/"))

# clean names
fnames <- gsub(".csv","",files_ucla)
fnames <- gsub("Re22Q_","",fnames)
fnames <- gsub("Form_","",fnames)
fnames <- gsub("Qry_","",fnames)

# read all, set to na: "-9999", "-9998","." 
input_all_ucla <- lapply(fpaths, read.csv, header=T, na.strings=c(".","-9999","-9998"), strip.white=T, sep=",")
names(input_all_ucla) <- fnames
df_all_ucla <- lapply(input_all_ucla, function(x) data.frame(x))

# subset demo_mri for used scans
ucla_demo <- df_all_ucla$demo_mri %>% filter(MRI_S_ID %in% all_sessions)

# remove "FAMILY MEMBER" designation from subject identity
ucla_demo$SUBJECT_IDENTITY <- ucla_demo$SUBJECT_IDENTITY %>% sub("FAMILY MEMBER","",.) %>% sub(",","",.) %>% trimws(which="both") %>% as.factor
# change sex coding from 0/1 to F/M and set to factor
ucla_demo$SEX <- factor(ucla_demo$SEX,levels=c(0,1),labels=c("F","M"))

# manually fix missing sex for Q_0381_09102019
# TODO: fix in sistat and re-export
ucla_demo[which(ucla_demo$MRI_S_ID == "Q_0381_09102019"),"SEX"] <- "F"

# set race=NA to 7 (unknown)
ucla_demo$RACE[is.na(ucla_demo$RACE)] <- 7
# set race as factor 1=American Indian/Alaska Native; 2=Asian; 3=Native Hawaiian/Pacific Islander; 4=Black or African American; 5=White; 6=Multiple; 7=Unknown
ucla_demo$RACE <- factor(ucla_demo$RACE,levels=c(1:7),labels=c("1_Native_American","2_Asian","3_Pacific_Island","4_Black","5_White","6_Multiple","7_Unknown"))
# ethnicity as factor with 0=N 1=Y
ucla_demo$HISPANIC[is.na(ucla_demo$HISPANIC)] <- "Unknown"
ucla_demo$HISPANIC <- factor(ucla_demo$HISPANIC,levels=c(0,1,"Unknown"),labels=c("N","Y","Unknown"))
# get more accurate age with AGEMONTH/12
ucla_demo$AGE <- as.numeric(ucla_demo$AGEMONTH)/12 

# function to add column to code timepoints relative to sample used (i.e. if visit 1 and 1.12 missing, then 1.24 is baseline)
# trio/prisma coded as T/P-visit_n where T-1 would be the subject's first trio scan and P-1 the first prisma, P-2 the second...
# function should be applied to the indicies of rows (r) in a subset of demo_mri
gettp <- function(r, df){
  sub <- df$SUBJECTID[[r]]
  visit <- df$CONVERTEDVISITNUM[[r]]
  all_visits <- df$CONVERTEDVISITNUM[which(df$SUBJECTID == sub)] %>% sort
  n_visits <- length(all_visits)
  nt_visits <-length(which(all_visits < 2))
  np_visits <- length(which(all_visits >= 2))
  visit_index <- which(all_visits == visit)
  if (visit < 2){
    label=paste("T-",visit_index,sep="")
  }else if (visit >= 2){
    p_visits <- all_visits[which(all_visits >= 2)] %>% sort
    p_visit_index <- which(p_visits == visit)
    label=paste("P-",p_visit_index,sep="")
  }
  return(c(sub,visit,label,n_visits,nt_visits,np_visits,visit_index))
}

# get timepoints
timepoints <- sapply(1:nrow(ucla_demo),function(r) gettp(r,ucla_demo)) %>% t %>% as.data.frame
colnames(timepoints) <- c("SUBJECTID","CONVERTEDVISITNUM","converted_timepoint","n_timepoints","n_trio","n_prisma","visit_index")
ucla_demo_tp <- cbind(ucla_demo,timepoints[,3:7])
ucla_demo_tp$visit_index %<>% as.factor

# subset to under max age limit (22 years old)
ucla_demo_tp_agelim <- filter(ucla_demo_tp, ucla_demo_tp$AGE < 22)

# subset to hcs del
ucla_demo_hcs_del <- ucla_demo_tp_agelim %>% filter(SUBJECT_IDENTITY=="CONTROL" | SUBJECT_IDENTITY =="PATIENT-DEL")

# remove unused factor levels
ucla_demo_hcs_del %<>% droplevels
```

All timepoints, pre-matching demographics summary
```{r}
demo_summary <- CreateTableOne(data=ucla_demo_hcs_del,vars=c("AGE","SEX"),strata="SUBJECT_IDENTITY",addOverall=F)
print(demo_summary, showAllLevels=T)
```

Baseline pre-matching summary
```{r}
demo_summary_bl <- CreateTableOne(data=filter(ucla_demo_hcs_del, ucla_demo_hcs_del$visit_index == 1),vars=c("AGE","SEX"),strata="SUBJECT_IDENTITY",addOverall=F)
print(demo_summary_bl)
```

merge TC with demo_mri
```{r}
demo_mri_tc <- merge(x=ucla_demo_hcs_del, y=all_tc_wide, by="MRI_S_ID")
demo_mri_tc_hcs_del <- demo_mri_tc %>% filter(SUBJECT_IDENTITY=="CONTROL" | SUBJECT_IDENTITY =="PATIENT-DEL")

# change class to factor
demo_mri_tc_hcs_del$SUBJECT_IDENTITY <- factor(demo_mri_tc_hcs_del$SUBJECT_IDENTITY)
demo_mri_tc_hcs_del$SUBJECTID <- factor(demo_mri_tc_hcs_del$SUBJECTID)
demo_mri_tc_hcs_del$site <- factor(demo_mri_tc_hcs_del$site)
demo_mri_tc_hcs_del$MRI_S_ID <- factor(demo_mri_tc_hcs_del$MRI_S_ID)

# list of TC network names
tc_names <- names(all_tc_wide)[which(!(names(all_tc_wide) %in% c("MRI_S_ID", "site")))]
```

## Harmonize sites
longCombat for TC 
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# set up longCombat variables
demovars <- c("MRI_S_ID","SUBJECTID","site","SUBJECT_IDENTITY","AGE","SEX","visit_index")
features <- tc_names
idvar <- 'MRI_S_ID'
batchvar <- 'site'
timevar <- 'visit_index'
formula <- 'SUBJECT_IDENTITY + AGE + SEX'
ranef <- '(1|SUBJECTID)'

combat_input_tc_hcs_del <- demo_mri_tc_hcs_del[,c(demovars,features)]

# run longCombat
tc_net_combat <- longCombat(idvar=idvar, 
                             timevar=timevar,
                             batchvar=batchvar, 
                             features=features, 
                             formula=formula,
                             ranef=ranef,
                             data=combat_input_tc_hcs_del)

# get the harmonized data
tc_net_combat_data <- tc_net_combat$data_combat

# merge combat back with original
demo_mri_tc_hcs_del_combat <- merge(x=demo_mri_tc_hcs_del, y=tc_net_combat_data, by=c("MRI_S_ID","visit_index","site"))

```

function to get smoothed estimates with upper and lower SE bounds
```{r}
smooth_estimates_se <- function(gamm,smooth,n){
  out <- smooth_estimates(gamm,smooth,n=n, partial_match = T)
  out$selo <- out$est - out$se
  out$sehi <- out$est + out$se
  return(out)
}

# get smooth estimates shifted by GAMM intercept to allow plotting over original data
smooth_estimates_se_b0 <- function(gamm,smooth,n){
  out <- smooth_estimates(gamm,smooth,n=n, partial_match = T)
  out$est <- out$est + gamm$coefficients["(Intercept)"]
  out$selo <- out$est - out$se
  out$sehi <- out$est + out$se
  return(out)
}
```

GAMM for harmonized TC
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# combat feature names
tc_names_combat <- paste(tc_names,".combat",sep="")

# generalized additive mixed model
gamm_tc_all_combat <- lapply(tc_names_combat,function(name) gam(reformulate(c("s(AGE,by=SUBJECT_IDENTITY)","SUBJECT_IDENTITY","SEX","s(SUBJECTID, bs=\"re\")"), response=name),selection=TRUE,method="REML",data=demo_mri_tc_hcs_del_combat))
names(gamm_tc_all_combat) <- tc_names_combat

# smooth estimate
smooth_tc_all_combat <- lapply(gamm_tc_all_combat, function(g) smooth_estimates_se_b0(gamm=g, smooth="s(AGE)", n=(40*12)))
names(smooth_tc_all_combat) <- tc_names_combat

```

plot all TC smooths
```{r}
# function to plot gamm and scatter
plot_gamm_points_tc_combat <- function(name){
  ggplot(data = smooth_tc_all_combat[[name]],  aes_string(x="AGE", y="est"))+
  geom_ribbon(aes_string(x = "AGE", ymin = "selo",ymax = "sehi", fill = "SUBJECT_IDENTITY"),alpha = .18, linetype = 0)+
  geom_line(aes_string(x = "AGE", y = "est", color = "SUBJECT_IDENTITY"),size = 1)+theme_bw()+
  theme_classic() + 
  theme(legend.title = element_blank())+
  ylab(paste("Mean",name))+
  ggtitle(paste(name,"Thalamocortical GAMM"))+
  scale_fill_manual(values = c("CONTROL" = "deepskyblue", "PATIENT-DEL" = "red")) +
  scale_color_manual(values = c("CONTROL" = "deepskyblue", "PATIENT-DEL" = "red")) +
  geom_point(data=demo_mri_tc_hcs_del_combat, aes_string(x="AGE", y=name, color="SUBJECT_IDENTITY", fill="SUBJECT_IDENTITY",shape="site")) +
  scale_shape_manual(values = c(17, 16)) 
}

lapply(tc_names_combat,function(x) plot_gamm_points_tc_combat(x))
```

plot three favorites
```{r}
plot_gamm_points_tc_combat_ylab <- function(name){
  ggplot(data = smooth_tc_all_combat[[name]],  aes_string(x="AGE", y="est"))+
  geom_ribbon(aes_string(x = "AGE", ymin = "selo",ymax = "sehi", fill = "SUBJECT_IDENTITY"),alpha = .18, linetype = 0)+
  geom_line(aes_string(x = "AGE", y = "est", color = "SUBJECT_IDENTITY"),size = 1)+theme_bw()+
  theme_classic() + 
  theme(legend.title = element_blank())+
  ylab("Thalamocortical connectivity (mean Fz)")+
  ylim(-1,1)+
  ggtitle(sub(".combat","",name))+
  theme(plot.title = element_text(vjust=-6, hjust=0.1))+
  scale_fill_manual(values = c("CONTROL" = "deepskyblue", "PATIENT-DEL" = "red")) +
  scale_color_manual(values = c("CONTROL" = "deepskyblue", "PATIENT-DEL" = "red")) +
  geom_point(data=demo_mri_tc_hcs_del_combat, aes_string(x="AGE", y=name, color="SUBJECT_IDENTITY", fill="SUBJECT_IDENTITY",shape="site")) +
  scale_shape_manual(values = c(17, 16)) 
}

plot_gamm_points_tc_combat_noylab <- function(name){
  ggplot(data = smooth_tc_all_combat[[name]],  aes_string(x="AGE", y="est"))+
  geom_ribbon(aes_string(x = "AGE", ymin = "selo",ymax = "sehi", fill = "SUBJECT_IDENTITY"),alpha = .18, linetype = 0)+
  geom_line(aes_string(x = "AGE", y = "est", color = "SUBJECT_IDENTITY"),size = 1)+theme_bw()+
  theme_classic() + 
  theme(legend.title = element_blank(),axis.title.y=element_blank())+
  theme(legend.title = element_blank(),axis.text.y=element_blank(),axis.title.y=element_blank())+
  ylim(-1,1)+
  ggtitle(sub(".combat","",name))+
  theme(plot.title = element_text(vjust=-6, hjust=0.1))+
  scale_fill_manual(values = c("CONTROL" = "deepskyblue", "PATIENT-DEL" = "red")) +
  scale_color_manual(values = c("CONTROL" = "deepskyblue", "PATIENT-DEL" = "red")) +
  geom_point(data=demo_mri_tc_hcs_del_combat, aes_string(x="AGE", y=name, color="SUBJECT_IDENTITY", fill="SUBJECT_IDENTITY",shape="site")) +
  scale_shape_manual(values = c(17, 16)) 
}
p1 <- plot_gamm_points_tc_combat_ylab("Frontoparietal.combat")
p23 <- lapply(c("Somatomotor.combat","Default.combat"),function(x) plot_gamm_points_tc_combat_noylab(x))
#grid.arrange(p3[[1]],p3[[2]],p3[[3]],nrow=1)

#ggarange not displaying in rmd but works if pasted into console
pf <- ggarrange(p1,p23[[1]],p23[[2]],nrow=1, common.legend=T,legend="right")
#ggsave("~/Dropbox/PhD/bearden_lab/22q/analyses/longitudinal_gamm/tc_plots_som_fpn_dmn.png", device="png",width=13 ,height=4, units="in", dpi = 100, plot=pf)
```

p-vals for significant age effect by group
```{r}
print("Somatomotor.combat")
summary(gamm_tc_all_combat[[which(tc_names_combat == "Somatomotor.combat")]], freq=T)$s.table
print("Frontoparietal.combat")
summary(gamm_tc_all_combat[[which(tc_names_combat == "Frontoparietal.combat")]], freq=T)$s.table

```


## test trio and prisma separately as sanity check
GAMM for trio only (no combat)
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# trio only
demo_mri_tc_hcs_del_trio <- droplevels(filter(demo_mri_tc_hcs_del, site == "trio"))
# GAMM
gamm_tc_trio <- lapply(tc_names,function(name) gam(reformulate(c("s(AGE,by=SUBJECT_IDENTITY)","SUBJECT_IDENTITY","SEX","s(SUBJECTID, bs=\"re\")"), response=name),selection=TRUE,method="REML",data=demo_mri_tc_hcs_del_trio))
names(gamm_tc_trio) <- tc_names

# smooth estimate
smooth_tc_trio <- lapply(gamm_tc_trio, function(g) smooth_estimates_se_b0(gamm=g, smooth="s(AGE)", n=(40*12)))
names(smooth_tc_trio) <- tc_names
```
plot trio
```{r}
# function to plot gamm and scatter
plot_gamm_points_tc_trio <- function(name){
  ggplot(data = smooth_tc_trio[[name]],  aes_string(x="AGE", y="est"))+
  geom_ribbon(aes_string(x = "AGE", ymin = "selo",ymax = "sehi", fill = "SUBJECT_IDENTITY"),alpha = .18, linetype = 0)+
  geom_line(aes_string(x = "AGE", y = "est", color = "SUBJECT_IDENTITY"),size = 1)+theme_bw()+
  theme_classic() + 
  theme(legend.title = element_blank())+
  ylab(paste("Mean",name))+
  ggtitle(paste(name,"Thalamocortical GAMM (trio)"))+
  scale_fill_manual(values = c("CONTROL" = "deepskyblue", "PATIENT-DEL" = "red")) +
  scale_color_manual(values = c("CONTROL" = "deepskyblue", "PATIENT-DEL" = "red")) +
  geom_point(data=demo_mri_tc_hcs_del_trio, aes_string(x="AGE", y=name, color="SUBJECT_IDENTITY", fill="SUBJECT_IDENTITY", shape="site")) 
}

lapply(tc_names,function(x) plot_gamm_points_tc_trio(x))
```
p-vals for trio only
```{r}
print("Somatomotor")
summary(gamm_tc_trio[[which(tc_names == "Somatomotor")]], freq=T)$s.table

print("Frontoparietal")
summary(gamm_tc_trio[[which(tc_names == "Frontoparietal")]], freq=T)$s.table

```


GAMM for prisma only (no combat)
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# prisma only
demo_mri_tc_hcs_del_prisma <- droplevels(filter(demo_mri_tc_hcs_del, site == "prisma"))
# GAMM
# TODO: prisma data won't work alone with gam, too few observations ("Model has more coefficients than data")
gamm_tc_prisma <- lapply(tc_names,function(name) gam(reformulate(c("s(AGE,by=SUBJECT_IDENTITY)","SUBJECT_IDENTITY","SEX","s(SUBJECTID, bs=\"re\")"), response=name),selection=TRUE,method="REML",data=demo_mri_tc_hcs_del_prisma))
names(gamm_tc_prisma) <- tc_names

# smooth estimate
smooth_tc_prisma <- lapply(gamm_tc_prisma, function(g) smooth_estimates_se_b0(gamm=g, smooth="s(AGE)", n=(40*12)))
names(smooth_tc_prisma) <- tc_names
```
plot prisma
```{r}
# function to plot gamm and scatter
plot_gamm_points_tc_prisma <- function(name){
  ggplot(data = smooth_tc_prisma[[name]],  aes_string(x="AGE", y="est"))+
  geom_ribbon(aes_string(x = "AGE", ymin = "selo",ymax = "sehi", fill = "SUBJECT_IDENTITY"),alpha = .18, linetype = 0)+
  geom_line(aes_string(x = "AGE", y = "est", color = "SUBJECT_IDENTITY"),size = 1)+theme_bw()+
  theme_classic() + 
  theme(legend.title = element_blank())+
  ylab(paste("Mean",name))+
  ggtitle(paste(name,"Thalamocortical GAMM (prisma)"))+
  scale_fill_manual(values = c("CONTROL" = "deepskyblue", "PATIENT-DEL" = "red")) +
  scale_color_manual(values = c("CONTROL" = "deepskyblue", "PATIENT-DEL" = "red")) +
  geom_point(data=demo_mri_tc_hcs_del_prisma, aes_string(x="AGE", y=name, color="SUBJECT_IDENTITY", fill="SUBJECT_IDENTITY", shape="site")) 
}

lapply(tc_names,function(x) plot_gamm_points_tc_prisma(x))
```


